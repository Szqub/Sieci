import paramiko
import getpass
import time
import sys

def connect_to_panorama():
    """Establish SSH connection to Panorama and execute commands."""
    # Get connection details from user
    hostname = input("Enter Panorama IP address: ")
    username = input("Enter username: ")
    password = getpass.getpass("Enter password: ")
    
    # Create SSH client
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    
    try:
        # Attempt connection
        print(f"Connecting to {hostname}...")
        ssh.connect(hostname=hostname, username=username, password=password, timeout=10)
        print("Connection established successfully!")
        
        # Start an interactive shell
        channel = ssh.invoke_shell()
        
        # Wait for the shell to initialize and show the > prompt
        prompt_ready = False
        max_init_attempts = 10
        init_attempts = 0
        
        while not prompt_ready and init_attempts < max_init_attempts:
            time.sleep(1)
            if channel.recv_ready():
                output = channel.recv(1024).decode('utf-8')
                print(output)
                # Check for the > prompt indicating system is ready
                if '>' in output:
                    prompt_ready = True
                    break
            init_attempts += 1
            
        if not prompt_ready:
            print("Timed out waiting for the initial prompt. Check your connection.")
            return
        
        # Enter configuration mode and wait for prompt to change
        channel.send("configure\n")
        
        # Wait for the prompt to change to #
        prompt_changed = False
        max_attempts = 10
        attempts = 0
        
        while not prompt_changed and attempts < max_attempts:
            time.sleep(1)
            if channel.recv_ready():
                output = channel.recv(1024).decode('utf-8')
                print(output)
                if '#' in output:
                    prompt_changed = True
                    break
            attempts += 1
            
        if prompt_changed:
            print("Successfully entered configuration mode!")
            
            continue_session = True
            while continue_session:
                # Get parameters from user
                device_group = input("Enter device group name: ")
                rulebase_type = input("Enter rulebase type (pre-rulebase/post-rulebase): ")
                rule_name = input("Enter rule name (or press Enter for all rules): ")
                
                # Construct command
                if rule_name:
                    command = f"run show device-group {device_group} {rulebase_type} security rules {rule_name}\n"
                else:
                    command = f"run show device-group {device_group} {rulebase_type} security rules\n"
                
                print(f"Executing command: {command}")
                channel.send(command)
                
                # Wait for response to start coming
                wait_time = 0
                while not channel.recv_ready() and wait_time < 10:
                    time.sleep(0.5)
                    wait_time += 0.5
                
                # Get the command output with patience
                buffer = ""
                last_receive_time = time.time()
                timeout = 30  # seconds to wait for complete output
                
                while time.time() - last_receive_time < timeout:
                    if channel.recv_ready():
                        part = channel.recv(4096).decode('utf-8')
                        buffer += part
                        last_receive_time = time.time()
                        
                        # If we see a command prompt, we might be done
                        if '#' in part.splitlines()[-1:]:
                            # Wait just a bit more to make sure we got everything
                            time.sleep(1)
                            if channel.recv_ready():
                                buffer += channel.recv(4096).decode('utf-8')
                            break
                    else:
                        time.sleep(0.5)
                
                print("\n--- Command Output ---")
                print(buffer)
                print("--- End of Output ---\n")
                
                # Ask if user wants to continue
                user_choice = input("Do you want to execute another command? (y/n): ").lower()
                continue_session = user_choice == 'y'
        
        else:
            print("Failed to enter configuration mode. Current prompt:", output.strip())
    
    except paramiko.AuthenticationException:
        print("Authentication failed. Please check your username and password.")
    except paramiko.SSHException as e:
        print(f"SSH error: {e}")
    except Exception as e:
        print(f"Connection error: {e}")
    finally:
        # Close connection
        if 'ssh' in locals() and ssh.get_transport() is not None:
            ssh.close()
            print("Connection closed.")

if __name__ == "__main__":
    print("Palo Alto Panorama CLI Connection Script")
    print("-" * 40)
    
    try:
        connect_to_panorama()
    except KeyboardInterrupt:
        print("\nProgram interrupted by user. Exiting...")
        sys.exit(0)
    except Exception as e:
        print(f"Unexpected error: {e}")
